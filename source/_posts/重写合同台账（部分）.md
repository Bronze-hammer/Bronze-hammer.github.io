---
title: 重写合同台账（部分）
date: 2019-01-22 19:55:29
tags:
- Oracle
categories:
- 数据库
---

### 重写了部分合并情况的SQL语句

原SQL语句由四部分组成，通过 UNION ALL 连接起来，SQL也并没有说明为什么要那样写，所以我根据自己的理解重写了一段SQL

<!-- more -->

```oracle
SELECT
    oo.name 公司,
    bp.project_name 项目,
    fcc.vbillcode 合同编码,
    fcc.vrealcontno 纸质合同编码,
    fb_ct.name 合同类型,
    fcc.vcontname 合同名称,
    fcc2.vcontname 主合同,
    od.name 经办部门,
    bs_s.name 合同乙方,
    bs_f.name 合同甲方,
    fcc.dbilldate 签订日期,
    decode(fcc.icontstatus,0,'生效',1,'未生效',2,'作废',3,'冻结',4,'完成',5,'中止','~') 合同状态,
    decode(fcc.icontexecstatus,0,'编制中',1,'执行中',2,'修订中',3,'结算中',4,'已结算','~') 合同执行状态,
    decode(fcc.icostsplitstatus,1,'部分拆分',2,'已拆分','~') 拆分状态,
    decode(fcc.fstatusflag,-1,'自由',0,'审批未通过',1,'审批通过',2,'审批进行中',3,'提交','~') 单据状态,
    fcc.ngpcontsignmny 合同签订金额原币,
    fcc.norigcontsignmny 合同签订金额,
    fcc.norigmaincontsnmny 主合同签订金额,
    fcc.norigctsumcostmny 合同总成本金额,
    fccs.vbillcode 结算单号,
    fccs.ngpctstlcstmny 合同结算金额原币,
    fccs.ngpctstlmny 合同结算金额,
    fccs.norigctstlcstmny 结算成本金额,
    nvl(fccb.norigcostmny,0) 合同动态成本金额,
    d.allapprmny 累计已申请金额,
    d.ngpallappmny 累计已申请金额原币,
    (nvl(fcc.norigcontsignmny,0) - nvl(fcc.norigrealapplymny,0)) 未申请金额,
    (nvl(fcc.ngpcontsignmny,0) - nvl(fcc.ngprealapplymny,0)) 未申请金额原币,
    fbc.name 核算对象,
    decode(nvl(fccb.vdef10,'~'),'~','','Y','是','否') 是否公摊核算对象,
    bp_b.project_name 拆分项目,
    rf.dispname 成本科目,
    fccb.norigcostmny 拆分金额
FROM fdcpm_cm_contract fcc
    LEFT JOIN org_orgs oo ON oo.pk_org=fcc.pk_org AND NVL(oo.dr,0)=0
    LEFT JOIN bd_project bp ON bp.pk_project=fcc.vprojectname AND NVL(bp.dr,0)=0
    LEFT JOIN fdcpm_bd_conttype fb_ct ON fb_ct.pk_conttype=fcc.pk_conttype AND NVL(fb_ct.dr,0)=0
    LEFT JOIN fdcpm_cm_contract fcc2 ON fcc2.pk_cont=fcc.pk_maincont AND NVL(fcc2.dr,0)=0
    LEFT JOIN org_dept od ON od.pk_dept=fcc.pk_dept AND NVL(od.dr,0)=0
    LEFT JOIN bd_supplier bs_f ON bs_f.pk_supplier=fcc.pk_first AND NVL(bs_f.dr,0)=0
    LEFT JOIN bd_supplier bs_s ON bs_s.pk_supplier=fcc.pk_second AND NVL(bs_s.dr,0)=0
    LEFT JOIN fdcpm_cm_contsettle fccs ON fccs.pk_cont=fcc.pk_cont AND NVL(fccs.dr,0)=0
    LEFT JOIN fdcpm_cm_costelem_b fccb ON fccb.pk_cont=fcc.pk_cont AND NVL(fccb.dr,0)=0
    LEFT JOIN(
        SELECT
            fpdt.pk_cont,
            fcc.vcontname,
            SUM(NVL(fpdt.norigcontplanmny,0)) norigcontplanmny,
            SUM(NVL(fpdt.norigthisapplymny,0)) allapprmny,
            SUM(NVL(DECODE(fpdt.vbdef1,'~','0',fpdt.vbdef1,to_number(fpdt.vbdef1)),0)) ngpallappmny
        FROM fdcpm_cm_contract fcc
            LEFT JOIN fdcpm_pay_apply fpa on fpa.pk_contract=fcc.pk_cont
            LEFT JOIN fdcpm_pay_detail fpdt on fpdt.pk_apply=fpa.pk_apply
        WHERE NVL(fcc.dr,0)=0 AND NVL(fpa.dr,0)=0 AND NVL(fpdt.dr,0)=0
        GROUP BY fpdt.pk_cont,fcc.vcontname
    ) d ON d.pk_cont=fcc.pk_cont
    LEFT JOIN fdcpub_bd_cbs fbc ON fbc.pk_cbs=fccb.pk_checkproject AND NVL(fbc.dr,0)=0
    LEFT JOIN bd_project bp_b ON bp_b.pk_project=fccb.pk_project AND NVL(bp_b.dr,0)=0
    LEFT JOIN resa_factorasoa rf ON rf.pk_factorasoa=fccb.pk_elem AND NVL(rf.dr,0)=0
WHERE NVL(fcc.dr,0)=0
AND (fcc.icostsplitstatus <> 0) AND fcc.fstatusflag IN (-1,1,2,3) AND fcc.icontexecstatus NOT IN (3,4)
AND oo.pk_org='00015A1000000002HAK2' AND bp.pk_project='10015A1000000003N9BO';

````
